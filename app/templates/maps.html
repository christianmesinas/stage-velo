{% extends "base.html" %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/maps.css') }}">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>
{% endblock %}

{% block content %}
    <div id="search-container">
     <input type="text" id="search-input" placeholder="Zoek op stationnummer of adres...">
     <button onclick="searchStation()">Zoek</button>
    </div>

    <div id="map"></div>

    <div id="show-all-container">
        <button onclick="showAvailableStations()">Toon alle beschikbare stations</button>
    </div>


    <div id="station-list-container" style="display: none;">
        <h3>Beschikbare stations</h3>
        <ul id="station-list"></ul>
    </div>



{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='js/maps.js') }}"></script>
 <script>
    // Functie om het juiste icoon te kiezen
    function createCustomIcon(status, freeBikes, emptySlots) {
        let iconUrl;
        if (status !== 'OPN') {
            iconUrl = '{{ url_for("static", filename="images/marker-red.png") }}';
        } else if (freeBikes === 0) {
            iconUrl = '{{ url_for("static", filename="images/marker-blue.png") }}';
        } else if (emptySlots === 0) {
            iconUrl = '{{ url_for("static", filename="images/marker-yellow.png") }}';
        } else {
            iconUrl = '{{ url_for("static", filename="images/marker-green.png") }}';
        }

        return L.icon({
            iconUrl: iconUrl,
            iconSize: [30, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
            shadowSize: [41, 41]
        });
    }

    // Markerdata van Flask
    const markers = {{ markers | tojson }};

    // Loop door markers en voeg ze toe aan de kaart
    markers.forEach(function(marker) {
    let customIcon = createCustomIcon(marker.status, marker['free-bikes'], marker['empty-slots']);
    let popupContent;
    if (marker.status === 'CLS') {
        popupContent = `${marker.name}<br><span style="color: red; font-weight: bold;">Closed</span>`;
    } else {
        popupContent = `
            ${marker.name}<br>
            <img src='/static/images/bike.png' alt='bike' style='height: 16px; vertical-align: middle;'> ${marker['free-bikes']}
            <img src='/static/images/lock-icon.png' alt='lock' style='height: 16px; vertical-align: middle;'> ${marker['empty-slots']}
        `;
    }
    L.marker([marker.lat, marker.lon], { icon: customIcon })
        .addTo(map)
        .bindPopup(popupContent);
});

    function searchStation() {
    const input = document.getElementById("search-input").value.toLowerCase().trim();
    let found = false;

    markers.forEach(function(marker) {
        const stationId = marker.id?.toString().toLowerCase();
        const stationName = marker.name.toLowerCase();

        if (stationId === input || stationName.includes(input)) {
            map.setView([marker.lat, marker.lon], 17);

            let popupContent;
            if (marker.status === 'CLS') {
                popupContent = `${marker.name}<br><span style="color: red; font-weight: bold;">Closed</span>`;
            } else {
                popupContent = `
                    ${marker.name}<br>
                    <img src='/static/images/bike.png' alt='bike' style='height: 16px; vertical-align: middle;'> ${marker['free-bikes']}
                    <img src='/static/images/lock-icon.png' alt='lock' style='height: 16px; vertical-align: middle;'> ${marker['empty-slots']}
                `;
            }

            L.popup()
                .setLatLng([marker.lat, marker.lon])
                .setContent(popupContent)
                .openOn(map);

            found = true;
        }
        function showAllStations() {
    if (markers.length === 0) return;

    const group = new L.featureGroup(
        markers.map(marker =>
            L.marker([marker.lat, marker.lon])
        )
    );
    map.fitBounds(group.getBounds().pad(0.2));
}
    });

    if (!found) {
        alert("Geen station gevonden met deze invoer.");
    }
}

    function showAvailableStations() {
    const container = document.getElementById("station-list-container");
    const list = document.getElementById("station-list");

    list.innerHTML = ''; // Maak de lijst leeg
    let count = 0;

    markers.forEach(function(marker) {
        if (marker.status === 'OPN' && marker['free-bikes'] > 0) {
            const li = document.createElement('li');
            li.innerHTML = `<strong>${marker.name}</strong> - ðŸš² ${marker['free-bikes']} vrije fietsen, ðŸ”’ ${marker['empty-slots']} lege plaatsen`;
            list.appendChild(li);
            count++;
        }
    });

    if (count === 0) {
        list.innerHTML = '<li>Geen stations beschikbaar.</li>';
    }

    container.style.display = 'block';
}


</script>

    <!--<button id="refresh-button">Ververs Data</button> -->
    <div id="map"></div>

{% endblock %}